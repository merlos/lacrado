<div class="container" data-controller="message">
<h1>New lacrado self-destroying message</h1>
<%= form_with url: messages_path, method: :post, format: :html, data: { message_target: "form", turbo: false, action: "submit->message#create" } do |f| %>
    <div>
    <label>Message content*:</label>
    <!-- content is intentionally NOT a named form input so it is NOT submitted to the server -->
    <textarea rows="10" required maxlength="1000" placeholder="Type your secure message here..." data-message-target="content" id="message-textarea"></textarea>
    <div><span id="char-counter">0</span> / <span id="max-chars"></span> characters</div>
    <br>
    </div>
    
  <div>
  <label>Password (optional)</label><br>
  <!-- password2 is intentionally not a named form input so it is NOT submitted to the server -->
  <input type="password" minlength="10" placeholder="********" maxlength="64" data-message-target="password2" id="password2-input">
  between 10 and 64 characters

  <!-- hidden flag that indicates whether a password2 was provided (sent to server) -->
  <%= f.hidden_field :password2_present, value: false, data: { message_target: "password2Present" } %>

  </div>
    <p id="default-options"><small>The message will be self-destroyed <strong id="default-summary">after being viewed <span id="default-views">1 time</span> or after <span id="default-expiration">3 days</span></strong>, whichever comes first.
    <br><a href="#" id="show-change-options">change auto-destroy options</a></small></p>
    <div>
    <fieldset id="change-options" style="display:none">
        <legend>Auto-destroy options</legend>
        <p> The message will be destroyed after the selected number of views or the expiration time, whichever comes first. </p>
        <div>
            <label>Destroy the message after viewed*:</label>
            <%= f.number_field :views_remaining, value: 1, min: 1, max: 50, id: "views-remaining-input" %> time(s)
        <div>
            <label>Expiration*:</label>
            <%= f.select :expiration_time, options_for_select(
                [
                    ["1 hour", "1_hour"],
                    ["3 hours", "3_hours"],
                    ["6 hours", "6_hours"],
                    ["12 hours", "12_hours"],
                    ["1 day", "1_day"],
                    ["3 days (default)", "3_days"],
                    ["7 days", "7_days"],
                    ["15 days", "15_days"],
                    ["1 month", "1_month"],
                    ["1 year", "1_year"]
                ], "3_days"), class: "form-select", required: true, id: "expiration-time-select" %>
        </div>
        <br>
        <div>
            <a href="#" id="hide-change-options">hide options</a> | 
            <a href="#" id="reset-to-defaults">reset to defaults</a>
        </div>
    </fieldset>
    <%= f.hidden_field :encrypted_content, data: { message_target: "encryptedContent" } %>
    <%= f.submit "Create Secure Link", class: 'btn btn-primary' %>
    </div>
  <% end %>
  
  </div> <!-- /container -->

  <script>
  // Hide show the fieldset 
  document.getElementById('change-options').style.display = 'none';
  
  const viewsInput = document.getElementById('views-remaining-input') || document.querySelector('input[name="views_remaining"]');
  const expirationSelect = document.getElementById('expiration-time-select') || document.querySelector('select[name="expiration_time"]');
  const defaultViews = document.getElementById('default-views');
  const defaultExpiration = document.getElementById('default-expiration');
  
  // Map of expiration values to readable text
  const expirationLabels = {
    '1_hour': '1 hour',
    '3_hours': '3 hours',
    '6_hours': '6 hours',
    '12_hours': '12 hours',
    '1_day': '1 day',
    '3_days': '3 days',
    '7_days': '7 days',
    '15_days': '15 days',
    '1_month': '1 month',
    '1_year': '1 year'
  };
  
  // Update the summary text
  function updateSummary() {
    if (!viewsInput || !expirationSelect || !defaultViews || !defaultExpiration) {
      console.error('Missing required elements for updateSummary');
      return;
    }
    const views = parseInt(viewsInput.value);
    const expiration = expirationSelect.value;
    
    // Update views with proper pluralization
    const viewsText = views === 1 ? '1 time' : `${views} times`;
    defaultViews.textContent = viewsText;
    
    defaultExpiration.textContent = expirationLabels[expiration] || '3 days';
  }
  
  // Show change options
  document.getElementById('show-change-options').addEventListener('click', function (event) {
    event.preventDefault();
    document.getElementById('default-options').style.display = 'none';
    document.getElementById('change-options').style.display = 'block';
  });
  
  // Hide change options
  document.getElementById('hide-change-options').addEventListener('click', function (event) {
    event.preventDefault();
    updateSummary();
    document.getElementById('change-options').style.display = 'none';
    document.getElementById('default-options').style.display = 'block';
  });
  
  // Reset to defaults
  document.getElementById('reset-to-defaults').addEventListener('click', function (event) {
    event.preventDefault();
    viewsInput.value = 1;
    expirationSelect.value = '3_days';
    updateSummary();
  });
  
  // Update summary when inputs change
  viewsInput.addEventListener('input', updateSummary);
  expirationSelect.addEventListener('change', updateSummary);

  function formatInt(number) {
    return number.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
  }
  
  // only if not previously defined
  if (typeof messageTextarea == 'undefined') {
    const messageTextarea = document.getElementById('message-textarea');
    const maxChars = messageTextarea.getAttribute('maxlength'); // Get the max length from the attribute
    const charCounter = document.getElementById('char-counter');

    // Display the max characters in the counter
    document.getElementById('max-chars').textContent = formatInt(maxChars);

    // Update the counter on input
    messageTextarea.addEventListener('input', () => {
      const currentLength = messageTextarea.value.length;
      // Update the counter display
      charCounter.textContent = formatInt(currentLength);
      // Change the color to red if the user is over the 90%
      charCounter.style.color = currentLength >= (maxChars*0.9) ? 'red' : 'black';
    });
  }
  
</script>